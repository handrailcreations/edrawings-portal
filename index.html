<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>eDrawings Upload Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f4f6; --card:#ffffff; --muted:#6b7280; --accent:#111827;
    --green:#10b981; --red:#ef4444; --link:#2563eb;
  }
  [data-theme="dark"] {
    --bg:#111827; --card:#1f2937; --muted:#9ca3af; --accent:#f3f4f6;
    --green:#10b981; --red:#ef4444; --link:#60a5fa;
  }
  [data-theme="dark"] .dropzone{background:#374151;border-color:#4b5563}
  [data-theme="dark"] .dropzone.drag{background:#4b5563;border-color:#6b7280}
  [data-theme="dark"] th{background:#374151}
  [data-theme="dark"] th:hover{background:#4b5563}
  [data-theme="dark"] td{border-bottom-color:#374151}
  [data-theme="dark"] .grid{border-color:#374151}
  [data-theme="dark"] .chip{background:#374151;color:#f3f4f6}
  [data-theme="dark"] .help-text{background:#374151}
  [data-theme="dark"] .token-input, [data-theme="dark"] #shareUrl{background:#374151;color:#f3f4f6;border-color:#4b5563}
  [data-theme="dark"] .btn:not(.copy):not(.delete){background:#f3f4f6;color:#111827}
  html,body{height:100%;margin:0;background:var(--bg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--accent)}
  .wrap{display:grid;grid-template-rows:1fr 1fr;min-height:100vh;gap:16px;padding:16px;box-sizing:border-box}
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:20px;display:flex;flex-direction:column}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  h1{margin:0 0 6px 0;font-size:20px}
  .muted{color:var(--muted)}
  .btn{appearance:none;border:none;background:var(--accent);color:white;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.alt{background:#374151}
  .btn.copy{background:var(--green)}
  .btn.delete{background:var(--red);padding:6px 10px;font-size:13px}
  .link{color:var(--link);text-decoration:none}
  .dropzone{
    flex:1;min-height:240px;border:2px dashed #d1d5db;border-radius:14px;background:#fafafa;
    display:flex;align-items:center;justify-content:center;text-align:center;padding:20px
  }
  .dropzone.drag{background:#eef2ff;border-color:#93c5fd}
  .fileline{display:flex;align-items:center;gap:10px;margin-top:12px;word-break:break-all}
  .grid{overflow:auto;margin-top:12px;border:1px solid #e5e7eb;border-radius:12px}
  table{border-collapse:collapse;width:100%}
  th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:left}
  th{background:#f8fafc;font-weight:600;font-size:14px;cursor:pointer;user-select:none}
  th:hover{background:#e2e8f0}
  th.sortable::after{content:'‚áÖ';margin-left:4px;opacity:0.3}
  th.sort-asc::after{content:'‚Üë';opacity:1}
  th.sort-desc::after{content:'‚Üì';opacity:1}
  .status{min-height:22px;color:var(--muted);margin-top:8px}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#111827;font-size:12px}
  .right{margin-left:auto}
  .token-input{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;font-family:monospace;font-size:14px}
  .login-form{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .help-text{background:#f8fafc;padding:12px;border-radius:8px;margin-top:12px;font-size:14px}
  .help-text a{color:var(--link)}
</style>
</head>
<body>
<div class="wrap">

  <!-- TOP: Upload area -->
  <section class="card" id="top">
    <div class="row">
      <div>
        <h1>Handrail Creations eDrawings HTML Upload</h1>
        <div class="muted">Drag & drop your <strong>.html</strong> file below. You'll get a shareable link immediately.<br><strong>Note:</strong> Files take approximately 30 seconds to go live after upload.</div>
      </div>
      <div class="right row">
        <span id="userBadge" class="chip">Not signed in</span>
        <button id="themeToggle" class="btn alt" title="Toggle dark mode">üåô</button>
        <button id="logoutBtn" class="btn alt" style="display:none">Sign out</button>
      </div>
    </div>

    <!-- Login form -->
    <div id="loginSection" class="login-form">
      <input id="tokenInput" type="password" placeholder="Paste your GitHub Personal Access Token here" class="token-input" />
      <button id="loginBtn" class="btn">Sign in</button>
    </div>

    <!-- Help text -->
    <div id="helpText" class="help-text">
      <strong>How to get your token:</strong><br>
      1. Go to <a href="https://github.com/settings/tokens?type=beta" target="_blank">GitHub Settings ‚Üí Personal access tokens</a><br>
      2. Click "Generate new token (fine-grained)"<br>
      3. Select your repository: <strong>handrailcreations/edrawings-portal</strong><br>
      4. Give it "Contents" permission (read/write)<br>
      5. Copy the token and paste it above
    </div>

    <div id="dropzone" class="dropzone" style="display:none">
      <div>
        <div style="font-size:18px;margin-bottom:6px">Drop your <b>eDrawings .html</b> file here</div>
        <div class="muted">‚Ä¶or click to choose a file</div>
      </div>
      <input id="fileInput" type="file" accept=".html" style="display:none" />
    </div>

    <div class="fileline" id="selectedFile" style="display:none"></div>

    <div class="row" id="afterUpload" style="display:none">
      <input id="shareUrl" type="text" readonly style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
      <button id="copyBtn" class="btn copy">Copy link</button>
      <a id="openBtn" class="btn" href="#" target="_blank">Open</a>
    </div>

    <div class="status" id="status"></div>
  </section>

  <!-- BOTTOM: Recent uploads -->
  <section class="card">
    <div class="row">
      <h1 style="margin:0">All Uploads</h1>
      <span id="fileCount" class="chip" style="margin-left:8px">0 files</span>
      <button id="refreshBtn" class="btn alt right">Refresh</button>
    </div>
    <div class="grid">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-column="name">File</th>
            <th class="sortable" data-column="uploader">Uploader</th>
            <th class="sortable sort-desc" data-column="date">Date</th>
            <th>Link</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="recentTbody">
          <tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </section>

</div>

<script>
/* =========================
   CONFIG ‚Äî SET THESE FIRST
   ========================= */
// Your GitHub org/user and repo that holds the HTML files
const GH_OWNER = 'handrailcreations';
const GH_REPO  = 'edrawings-portal';
// The public base URL where Pages serves the files
const PAGES_BASE = 'https://handrailcreations.github.io/edrawings-portal/';

/* ---------- Sorting state ---------- */
let currentSort = { column: 'date', direction: 'desc' };
let allFiles = [];

const els = {
  dz: document.getElementById('dropzone'),
  fi: document.getElementById('fileInput'),
  sel: document.getElementById('selectedFile'),
  tokenInput: document.getElementById('tokenInput'),
  loginBtn: document.getElementById('loginBtn'),
  loginSection: document.getElementById('loginSection'),
  helpText: document.getElementById('helpText'),
  logout: document.getElementById('logoutBtn'),
  userBadge: document.getElementById('userBadge'),
  status: document.getElementById('status'),
  shareUrl: document.getElementById('shareUrl'),
  copyBtn: document.getElementById('copyBtn'),
  openBtn: document.getElementById('openBtn'),
  afterUpload: document.getElementById('afterUpload'),
  recentTbody: document.getElementById('recentTbody'),
  refreshBtn: document.getElementById('refreshBtn'),
  fileCount: document.getElementById('fileCount'),
  themeToggle: document.getElementById('themeToggle'),
};

/* ---------- Token storage ---------- */
function setToken(t){sessionStorage.setItem('gh_token', t)}
function getToken(){return sessionStorage.getItem('gh_token')}
function clearToken(){sessionStorage.removeItem('gh_token')}

/* ---------- Auth UI ---------- */
function setSignedIn(user){
  els.userBadge.textContent = user ? `Signed in: ${user.login}` : 'Not signed in';
  els.loginSection.style.display = user ? 'none' : '';
  els.helpText.style.display = user ? 'none' : '';
  els.logout.style.display = user ? '' : 'none';
  els.dz.style.display = user ? '' : 'none';
}

/* ---------- Login with token ---------- */
async function loginWithToken(){
  const token = els.tokenInput.value.trim();
  if(!token){
    els.status.textContent = 'Please enter a GitHub Personal Access Token';
    return;
  }

  els.status.textContent = 'Verifying token...';
  els.loginBtn.disabled = true;

  try {
    // Test the token by getting user info
    const response = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Accept': 'application/vnd.github+json'
      }
    });

    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('Invalid token. Please check your token and try again.');
      }
      throw new Error(`GitHub API error: ${response.status}`);
    }

    const user = await response.json();
    
    // Test repository access
    const repoResponse = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}`, {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Accept': 'application/vnd.github+json'
      }
    });

    if (!repoResponse.ok) {
      throw new Error(`Cannot access repository ${GH_OWNER}/${GH_REPO}. Make sure your token has access to this repository.`);
    }

    // Success!
    setToken(token);
    setSignedIn(user);
    els.status.textContent = `Successfully signed in as ${user.login}!`;
    els.tokenInput.value = '';
    
    // Load recent uploads
    renderRecent();

  } catch (error) {
    els.status.textContent = error.message;
  } finally {
    els.loginBtn.disabled = false;
  }
}

/* ---------- GitHub API helpers ---------- */
async function gh(path, opts={}){
  const token = getToken();
  if (!token) {
    throw new Error('No authentication token found');
  }
  
  const headers = { 
    'Accept': 'application/vnd.github+json',
    'X-GitHub-Api-Version': '2022-11-28'
  };
  
  headers['Authorization'] = `Bearer ${token}`;
  
  // Merge with any additional headers from opts
  if (opts.headers) {
    Object.assign(headers, opts.headers);
  }
  
  return fetch(`https://api.github.com${path}`, {
    ...opts,
    headers
  });
}

async function getUser(){
  const t = getToken();
  if(!t) return null;
  try {
    const r = await gh('/user');
    if(!r.ok) {
      clearToken();
      return null;
    }
    return r.json();
  } catch (error) {
    return null;
  }
}

async function listFiles(){
  try {
    const r = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/`);
    if(!r.ok){ return []; }
    const arr = await r.json();
    return arr.filter(x => x.type==='file' && x.name.toLowerCase().endsWith('.html') && x.name !== 'index.html');
  } catch (error) {
    return [];
  }
}

async function getLatestCommitForPath(path){
  try {
    const r = await gh(`/repos/${GH_OWNER}/${GH_REPO}/commits?path=${encodeURIComponent(path)}&per_page=1`);
    if(!r.ok) return null;
    const [commit] = await r.json();
    return commit || null;
  } catch (error) {
    return null;
  }
}

function fileSafeName(name){
  return name.replace(/\s+/g,'_').replace(/[^\w\-\.]/g,'');
}

function toBase64(arrayBuffer){
  let binary = '';
  const bytes = new Uint8Array(arrayBuffer);
  const len = bytes.byteLength;
  for(let i=0;i<len;i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

/* ---------- Delete file ---------- */
async function deleteFile(filename, button){
  if (!confirm(`Are you sure you want to delete "${filename}"?\n\nThis cannot be undone.`)) {
    return;
  }

  const token = getToken();
  if(!token){
    els.status.textContent = 'Please sign in first.';
    return;
  }

  button.disabled = true;
  button.textContent = 'Deleting...';
  els.status.textContent = `Deleting ${filename}...`;

  try {
    // First get the file's SHA (required for deletion)
    const getFile = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(filename)}`);
    
    if (!getFile.ok) {
      throw new Error('File not found or no access');
    }

    const fileData = await getFile.json();
    const user = await getUser();

    // Delete the file
    const deleteResponse = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(filename)}`, {
      method: 'DELETE',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        message: `Delete ${filename} by ${user?.login || 'unknown'}`,
        sha: fileData.sha,
        branch: 'main'
      })
    });

    if (!deleteResponse.ok) {
      const err = await deleteResponse.json().catch(()=>({}));
      throw new Error(err.message || `Delete failed: ${deleteResponse.status}`);
    }

    els.status.textContent = `‚úî Successfully deleted ${filename}`;
    
    // Refresh the list
    renderRecent();

  } catch (error) {
    els.status.textContent = `Delete failed: ${error.message}`;
    button.disabled = false;
    button.textContent = 'Delete';
  }
}

/* ---------- Upload flow ---------- */
async function uploadFile(file){
  els.status.textContent = 'Uploading‚Ä¶';
  const token = getToken();
  if(!token){
    els.status.textContent = 'Please sign in first.';
    return;
  }

  try {
    // First, let's verify we can access the repository
    els.status.textContent = 'Checking repository access‚Ä¶';
    const repoCheck = await gh(`/repos/${GH_OWNER}/${GH_REPO}`);
    if (!repoCheck.ok) {
      if (repoCheck.status === 404) {
        throw new Error(`Repository ${GH_OWNER}/${GH_REPO} not found or no access. Check your token permissions.`);
      }
      throw new Error(`Repository access failed: ${repoCheck.status}`);
    }

    els.status.textContent = 'Processing file‚Ä¶';
    const arrayBuf = await file.arrayBuffer();
    const b64 = toBase64(arrayBuf);
    const filename = fileSafeName(file.name || 'model.html');

    els.status.textContent = 'Checking if file exists‚Ä¶';
    // Check if file exists to pass sha for update
    let existingSha = null;
    const head = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(filename)}`);
    if(head.ok){
      const meta = await head.json();
      existingSha = meta.sha;
      els.status.textContent = `Updating existing file: ${filename}`;
    } else {
      els.status.textContent = `Creating new file: ${filename}`;
    }

    const user = await getUser();
    const message = existingSha
      ? `Update ${filename} by ${user?.login || 'unknown'}`
      : `Add ${filename} by ${user?.login || 'unknown'}`;

    const body = {
      message,
      content: b64,
      branch: 'main'
    };
    if(existingSha) body.sha = existingSha;

    els.status.textContent = 'Uploading to GitHub‚Ä¶';
    const uploadUrl = `/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(filename)}`;
    console.log('Upload URL:', uploadUrl);
    console.log('Upload body:', body);
    console.log('Token present:', !!token);
    console.log('Token starts with:', token ? token.substring(0, 10) + '...' : 'NO TOKEN');

    const put = await gh(uploadUrl, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });

    console.log('Upload response status:', put.status);
    
    if(!put.ok){
      const err = await put.json().catch(()=>({}));
      console.log('Upload error:', err);
      
      let errorMsg = err.message || `HTTP ${put.status}`;
      if (put.status === 404) {
        errorMsg = `Repository or branch not found. Check: 1) Repository exists, 2) Branch is 'main', 3) Token has 'Contents' permission`;
      } else if (put.status === 403) {
        errorMsg = `Permission denied. Your token needs 'Contents' write permission for this repository`;
      } else if (put.status === 422) {
        errorMsg = `Invalid request: ${err.message || 'Check file content and branch name'}`;
      }
      
      throw new Error(errorMsg);
    }

    els.status.textContent = 'Uploaded ‚úî';
    const url = PAGES_BASE + encodeURIComponent(filename);
    els.shareUrl.value = url;
    els.afterUpload.style.display = '';
    els.openBtn.href = url;

    // Refresh recent list
    renderRecent();

  } catch (error) {
    els.status.textContent = 'Upload failed: ' + error.message;
    console.error('Upload error:', error);
  }
}

/* ---------- UI wiring ---------- */
els.loginBtn.addEventListener('click', loginWithToken);
els.tokenInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') loginWithToken();
});
els.logout.addEventListener('click', ()=>{ 
  clearToken(); 
  setSignedIn(null);
  els.status.textContent = '';
});
els.copyBtn.addEventListener('click', ()=>{
  els.shareUrl.select(); 
  navigator.clipboard.writeText(els.shareUrl.value).then(() => {
    els.status.textContent = 'Link copied to clipboard.';
  }).catch(() => {
    document.execCommand('copy');
    els.status.textContent = 'Link copied to clipboard.';
  });
});
els.refreshBtn.addEventListener('click', ()=>renderRecent());

/* ---------- Dark mode toggle ---------- */
function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? '' : 'dark';
  
  html.setAttribute('data-theme', newTheme);
  sessionStorage.setItem('theme', newTheme);
  
  els.themeToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

els.themeToggle.addEventListener('click', toggleTheme);

/* ---------- Attach sort handlers using event delegation ---------- */
document.querySelector('table thead').addEventListener('click', function(e) {
  const th = e.target.closest('th.sortable');
  if (th) {
    const column = th.getAttribute('data-column');
    sortTable(column);
  }
});

/* Drag & drop */
['dragenter','dragover'].forEach(ev=>{
  els.dz.addEventListener(ev, e=>{ e.preventDefault(); els.dz.classList.add('drag'); });
});
['dragleave','drop'].forEach(ev=>{
  els.dz.addEventListener(ev, e=>{ e.preventDefault(); els.dz.classList.remove('drag'); });
});
els.dz.addEventListener('click', ()=>els.fi.click());
els.dz.addEventListener('drop', e=>{
  const f = e.dataTransfer?.files?.[0];
  if(f){ showSelected(f); uploadFile(f); }
});
els.fi.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if(f){ showSelected(f); uploadFile(f); }
});
function showSelected(f){
  els.sel.style.display = '';
  els.sel.textContent = `Selected: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
  els.afterUpload.style.display = 'none';
  els.status.textContent = '';
}

/* ---------- Sort table ---------- */
function sortTable(column) {
  console.log('sortTable called with column:', column);
  // Toggle direction if clicking same column
  if (currentSort.column === column) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = column;
    currentSort.direction = column === 'date' ? 'desc' : 'asc'; // Default date to newest first
  }
  
  console.log('Current sort:', currentSort);
  renderTable();
}

function renderTable() {
  console.log('renderTable called, allFiles length:', allFiles.length);
  if (!allFiles.length) return;
  
  // Sort the files
  const sorted = [...allFiles].sort((a, b) => {
    let aVal, bVal;
    
    if (currentSort.column === 'name') {
      aVal = a.name.toLowerCase();
      bVal = b.name.toLowerCase();
    } else if (currentSort.column === 'uploader') {
      aVal = a.uploader.toLowerCase();
      bVal = b.uploader.toLowerCase();
    } else if (currentSort.column === 'date') {
      aVal = a.when?.getTime() || 0;
      bVal = b.when?.getTime() || 0;
    }
    
    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
    return 0;
  });
  
  // Update table headers
  document.querySelectorAll('th.sortable').forEach(th => {
    th.classList.remove('sort-asc', 'sort-desc');
  });
  
  const columnMap = { name: 0, uploader: 1, date: 2 };
  const activeHeader = document.querySelectorAll('th.sortable')[columnMap[currentSort.column]];
  if (activeHeader) {
    activeHeader.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
  }
  
  // Render rows
  els.recentTbody.innerHTML = sorted.map((r)=>{
    const dateStr = r.when ? r.when.toLocaleString() : '‚Äî';
    const escapedName = r.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    return `<tr>
      <td>${r.name}</td>
      <td>${r.uploader}</td>
      <td>${dateStr}</td>
      <td><a class="link" href="${r.url}" target="_blank">Open</a></td>
      <td><button class="btn delete" data-filename="${escapedName}">Delete</button></td>
    </tr>`;
  }).join('');
  
  // Attach delete handlers
  document.querySelectorAll('.btn.delete').forEach(btn => {
    btn.addEventListener('click', function() {
      const filename = this.getAttribute('data-filename');
      deleteFile(filename, this);
    });
  });
}

/* ---------- Recent uploads ---------- */
async function renderRecent(){
  els.recentTbody.innerHTML = `<tr><td colspan="5" class="muted">Loading‚Ä¶</td></tr>`;
  els.fileCount.textContent = 'Loading...';
  
  const files = await listFiles();
  
  // Update file count
  els.fileCount.textContent = `${files.length} file${files.length !== 1 ? 's' : ''}`;
  
  if(!files.length){
    els.recentTbody.innerHTML = `<tr><td colspan="5" class="muted">No uploads yet.</td></tr>`;
    allFiles = [];
    return;
  }

  // Fetch all file data
  const rows = [];
  for(const f of files){
    const commit = await getLatestCommitForPath(f.path);
    const when = commit?.commit?.committer?.date || null;
    const uploader = (commit?.author?.login) || (commit?.committer?.login) || '‚Äî';
    rows.push({
      name: f.name,
      url: PAGES_BASE + encodeURIComponent(f.name),
      uploader, 
      when: when ? new Date(when) : null
    });
  }
  
  // Store globally for sorting
  allFiles = rows;
  
  // Render with current sort
  renderTable();
}

/* ---------- Boot ---------- */
(async function boot(){
  // Restore theme preference
  const savedTheme = sessionStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    els.themeToggle.textContent = '‚òÄÔ∏è';
  }
  
  const user = await getUser();
  setSignedIn(user);
  if (user) {
    renderRecent();
  }
})();
</script>
</body>
</html>
